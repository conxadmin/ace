# Export WS
src_ws = (cw)
exportDestinationPath = ($src_ws expw)

# Import WS
src_index = (repo:index ${exportDestinationPath}/jars_and_configs)
sourcerepo = (repo:repo R5 $src_index)
artifacts = repo:ls $sourcerepo


# Import WS: install resource processor & get OBR url
workspace = (cw4imp)
$workspace irp
targetRepoUrl = $workspace getObrUrl
targetRepo = (repo:repo OBR $targetRepoUrl)
$workspace commit

# Import WS: copy to OBR
repo:cp $sourcerepo $targetRepo
artifacts = repo:ls $targetRepo


# Import WS: Import bundles
workspace = (cw4imp)
each $artifacts {identity = $it getIdentity; version = $it getVersion; name = "$identity - $version"; url = $it getUrl; mimetype = $it getMimetype; if { (coll:first ($workspace la "(artifactName=$name)")) } { } { if { $mimetype equals "application/xml:osgi-autoconf" } { $workspace ca [ artifactName="$name" url="$url" mimetype="$mimetype" filename="$name" processorPid="org.osgi.deployment.rp.autoconf" ]; echo "Created autoconf $name" } { $workspace ca [ artifactName="$name" url="$url" mimetype="$mimetype" Bundle-SymbolicName="$identity" Bundle-Version="$version" ]; echo "Created bundle $name" }} }
#$workspace ca [ artifactName="${autoConfBundleSymbolicName} - ${autoConfBundleVersion}" url="${autoConfBundleURL}" mimetype="application/vnd.osgi.bundle" Bundle-SymbolicName="${autoConfBundleSymbolicName}" Bundle-Version="${autoConfBundleVersion}" ]
$workspace commit

# Import WS: Import Auto Confs
workspace = (cw4imp)
artifacts = repo:ls $sourcerepo "(type=file)"
each $artifacts {identity = $it getIdentity; version = $it getVersion; name = "$identity - $version"; url = $it getUrl; mimetype = $it getMimetype; if { (coll:first ($workspace la "(artifactName=$name)")) } { } { if { $mimetype equals "application/xml:osgi-autoconf" } { $workspace ca [ artifactName="$name" url="$url" mimetype="$mimetype" filename="$name" processorPid="org.osgi.deployment.rp.autoconf" ]; echo "Created autoconf $name" } { $workspace ca [ artifactName="$name" url="$url" mimetype="$mimetype" Bundle-SymbolicName="$identity" Bundle-Version="$version" ]; echo "Created bundle $name" }} }
$workspace commit


workspace = (cw4imp)
targets = ($workspace lsTargetFiles ${exportDestinationPath})
$workspace commit
each $targets { workspace = (cw4imp); fileName = $it; echo $fileName; $workspace impw ${exportDestinationPath} $fileName false; $workspace commit; $workspace cleanTempDirectory}

# Create targets from xml files
workspace = (cw4imp)
$workspace cts
$workspace commit

misc:shutdown 0